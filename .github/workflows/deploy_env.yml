name: Deploy Environments

on:
    push:
        branches:
            - main
            - develop
            - feature/sandro-deploy_env
    workflow_dispatch:

jobs:
    deploy_dev:
        runs-on: ubuntu-latest

        env:
            KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}

        steps:
            -   name: Checkout repository
                uses: actions/checkout@v4

            -   name: Configure kubectl
                run: |
                    mkdir -p ~/.kube
                    echo "${KUBE_CONFIG}" > ~/.kube/config
                    chmod 600 ~/.kube/config
                    kubectl config get-contexts || true

            -   name: Apply Kubernetes manifests (dev)
                run: |
                    kubectl apply -f k8s/namespace-dev.yml
                    kubectl apply -f k8s/configmap-dev.yml
                    kubectl apply -f k8s/deployment-dev.yml
                    kubectl apply -f k8s/service-dev.yml

    deploy_staging:
        runs-on: ubuntu-latest
        needs: deploy_dev
        environment:
            name: staging

        env:
            KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}

        steps:
            -   name: Checkout repository
                uses: actions/checkout@v4

            -   name: Configure kubectl
                run: |
                    mkdir -p ~/.kube
                    echo "${KUBE_CONFIG}" > ~/.kube/config
                    chmod 600 ~/.kube/config
                    kubectl config get-contexts || true

            -   name: Apply Kubernetes manifests (staging)
                run: |
                    kubectl apply -f k8s/namespace-staging.yml
                    kubectl apply -f k8s/configmap-staging.yml
                    kubectl apply -f k8s/deployment-staging.yml
                    kubectl apply -f k8s/service-staging.yml
